`timescale 1ns / 1ps

// =============================================================
// EXT: 立即数扩展模块 (Immediate Generator)
// =============================================================
// 功能: 根据指令类型，将指令中分散的立即数字段拼接成 32 位扩展立即数
//
// RISC-V 的立即数并不总在同一段 bit 里，而是按指令类型分为:
//   I-Type / S-Type / B-Type / U-Type / J-Type
//
// 本模块根据 ext_op 选择哪一种格式，把 instr[31:7] 里相关位拼成 32 位立即数
// =============================================================

// =============================================================
// RV32I 五种立即数格式详解
// =============================================================
//
// 【I-Type 立即数】用于: ADDI, SLTI, XORI, ORI, ANDI, JALR, Load 等
// ─────────────────────────────────────────────────────────────
// 指令格式:  imm[11:0]  | rs1   | funct3 | rd    | opcode
//            [31:20]    [19:15]  [14:12]  [11:7]   [6:0]
// 立即数:    {{20{instr[31]}}, instr[31:20]}
//            符号扩展 instr[31] 到高 20 位
//
// 【S-Type 立即数】用于: SB, SH, SW
// ─────────────────────────────────────────────────────────────
// 指令格式:  imm[11:5] | rs2   | rs1   | funct3 | imm[4:0] | opcode
//            [31:25]   [24:20] [19:15]  [14:12]   [11:7]     [6:0]
// 立即数:    {{20{instr[31]}}, instr[31:25], instr[11:7]}
//
// 【B-Type 立即数】用于: BEQ, BNE, BLT, BGE, BLTU, BGEU
// ─────────────────────────────────────────────────────────────
// 指令格式:  imm[12|10:5] | rs2   | rs1   | funct3 | imm[4:1|11] | opcode
//            [31|30:25]   [24:20] [19:15]  [14:12]   [11:8|7]      [6:0]
// 立即数:    {{19{instr[31]}}, instr[31], instr[7], instr[30:25], instr[11:8], 1'b0}
//            注意: 最低位固定为 0 (2字节对齐，跳转目标必须是偶地址)
//
// 【J-Type 立即数】用于: JAL
// ─────────────────────────────────────────────────────────────
// 指令格式:  imm[20|10:1|11|19:12] | rd    | opcode
//            [31|30:21|20|19:12]   [11:7]   [6:0]
// 立即数:    {{11{instr[31]}}, instr[31], instr[19:12], instr[20], instr[30:21], 1'b0}
//            注意: 最低位固定为 0 (2字节对齐)
//
// 【U-Type 立即数】用于: LUI, AUIPC
// ─────────────────────────────────────────────────────────────
// 指令格式:  imm[31:12]        | rd    | opcode
//            [31:12]           [11:7]   [6:0]
// 立即数:    {instr[31:12], 12'b0}
//            低 12 位补 0，高 20 位直接取指令
//
// =============================================================
// 立即数格式 bit 位置对比图
// =============================================================
//        31 30      25 24  21 20 19      12 11  8 7  6      0
// I:    [        imm[11:0]       ] [rs1] [f3] [ rd ] [opcode]
// S:    [ imm[11:5] ] [rs2] [rs1] [f3] [imm[4:0]] [opcode]
// B:    [12|10:5   ] [rs2] [rs1] [f3] [4:1|11  ] [opcode]
// U:    [        imm[31:12]              ] [ rd ] [opcode]
// J:    [20|10:1      |11|19:12          ] [ rd ] [opcode]
// =============================================================
//
// 初学者提示:
// - {{N{bit}}, ...} 是"重复拼接"，常用于符号扩展：用最高位复制 N 次
// - B/J 类立即数最低位固定为 0（因为跳转目标按 2 字节对齐）
// =============================================================

module EXT(
    input  [31:7] instr,      // 指令的 [31:7] 位 (包含立即数字段)
    input  [5:0]  ext_op,     // 立即数扩展类型选择
    output reg [31:0] imm_out // 扩展后的 32 位立即数
);

    // ---------------------------------------------------------
    // 1. 立即数类型常量定义 (与 ctrl.v 保持一致)
    // ---------------------------------------------------------
    localparam EXT_I_TYPE = 6'd0;  // I-Type: ADDI, Load, JALR 等
    localparam EXT_S_TYPE = 6'd1;  // S-Type: Store 指令
    localparam EXT_B_TYPE = 6'd2;  // B-Type: Branch 指令
    localparam EXT_J_TYPE = 6'd3;  // J-Type: JAL 指令
    localparam EXT_U_TYPE = 6'd4;  // U-Type: LUI, AUIPC

    // ---------------------------------------------------------
    // 2. 各类型立即数计算 (组合逻辑)
    // ---------------------------------------------------------
    // 先把 5 种类型的立即数都"算出来"，最后再按 ext_op 选择其中一个输出

    // I-Type: 12 位立即数，符号扩展到 32 位
    wire [31:0] imm_i = {{20{instr[31]}}, instr[31:20]};

    // S-Type: 12 位立即数分散在两处，符号扩展
    wire [31:0] imm_s = {{20{instr[31]}}, instr[31:25], instr[11:7]};

    // B-Type: 13 位立即数 (最低位为0)，符号扩展
    wire [31:0] imm_b = {{19{instr[31]}}, instr[31], instr[7], instr[30:25], instr[11:8], 1'b0};

    // J-Type: 21 位立即数 (最低位为0)，符号扩展
    wire [31:0] imm_j = {{11{instr[31]}}, instr[31], instr[19:12], instr[20], instr[30:21], 1'b0};

    // U-Type: 20 位立即数放高位，低 12 位补 0
    wire [31:0] imm_u = {instr[31:12], 12'b0};

    // ---------------------------------------------------------
    // 3. 立即数选择输出
    // ---------------------------------------------------------
    always @(*) begin
        case(ext_op)
            EXT_I_TYPE: imm_out = imm_i;
            EXT_S_TYPE: imm_out = imm_s;
            EXT_B_TYPE: imm_out = imm_b;
            EXT_J_TYPE: imm_out = imm_j;
            EXT_U_TYPE: imm_out = imm_u;
            default:    imm_out = 32'd0;
        endcase
    end

endmodule
